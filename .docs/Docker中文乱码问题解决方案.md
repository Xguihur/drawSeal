# Docker ç¯å¢ƒä¸­æ–‡ä¹±ç é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

æœ¬é¡¹ç›®çš„å°ç« ç”ŸæˆæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œæ­£å¸¸ï¼Œä½†åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œæ—¶ï¼Œä¸­æ–‡å­—ç¬¦ä¼šå˜æˆä¹±ç æˆ–äºŒè¿›åˆ¶ç ï¼Œå¯¼è‡´ç”Ÿæˆçš„å°ç« æ— æ³•æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### 1. ç—‡çŠ¶è¡¨ç°

- âœ… **æœ¬åœ°ç¯å¢ƒ**ï¼ˆmacOSï¼‰ï¼šä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸
- âŒ **Docker å®¹å™¨**ï¼šä¸­æ–‡å˜æˆä¹±ç æˆ–æ˜¾ç¤ºä¸º `\uXXXX` å½¢å¼çš„ç¼–ç 

### 2. æ ¹æœ¬åŸå› 

Docker å®¹å™¨ä¸­ç¼ºå°‘ä¸­æ–‡æ”¯æŒçš„å…³é”®é…ç½®ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

| é—®é¢˜é¡¹ | ç¼ºå¤±å†…å®¹ | å½±å“ |
|-------|---------|------|
| **Locale é…ç½®** | ç¼ºå°‘ UTF-8 locale | ç³»ç»Ÿæ— æ³•æ­£ç¡®è§£æ UTF-8 ç¼–ç çš„ä¸­æ–‡å­—ç¬¦ |
| **ç¯å¢ƒå˜é‡** | æœªè®¾ç½® `LANG`ã€`LC_ALL` | Pango/Cairo æ¸²æŸ“åº“æ— æ³•è¯†åˆ«ä¸­æ–‡å­—ç¬¦ç¼–ç  |
| **å­—ä½“ç®¡ç†å·¥å…·** | ç¼ºå°‘ `fontconfig` | æ— æ³•æ­£ç¡®ç®¡ç†å’ŒåŠ è½½å­—ä½“æ–‡ä»¶ |
| **Fallback å­—ä½“** | ç¼ºå°‘ç³»ç»Ÿä¸­æ–‡å­—ä½“ | å½“è‡ªå®šä¹‰å­—ä½“åŠ è½½å¤±è´¥æ—¶æ²¡æœ‰å¤‡ç”¨æ–¹æ¡ˆ |

### 3. æŠ€æœ¯ç»†èŠ‚

#### ä¸ºä»€ä¹ˆæœ¬åœ°æ­£å¸¸ï¼ŒDocker å¼‚å¸¸ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç¯å¢ƒ        â”‚   Locale     â”‚   å­—ä½“é…ç½®      â”‚   ç»“æœ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœ¬åœ° macOS      â”‚ âœ… UTF-8     â”‚ âœ… ç³»ç»Ÿä¸­æ–‡å­—ä½“ â”‚ âœ… æ­£å¸¸  â”‚
â”‚ Docker å®¹å™¨     â”‚ âŒ POSIX/C   â”‚ âš ï¸ ä»…è‡ªå®šä¹‰å­—ä½“ â”‚ âŒ ä¹±ç   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Node Canvas æ¸²æŸ“åŸç†

```
Node.js (canvas åº“)
    â†“
Cairo å›¾å½¢åº“ (åº•å±‚æ¸²æŸ“)
    â†“
Pango æ–‡å­—æ’ç‰ˆåº“ (æ–‡å­—æ¸²æŸ“)
    â†“
Fontconfig (å­—ä½“æŸ¥æ‰¾å’Œç®¡ç†)
    â†“
ç³»ç»Ÿå­—ä½“æ–‡ä»¶ + Locale è®¾ç½®
```

**å…³é”®ç‚¹**ï¼š
- Pango ä¾èµ–æ­£ç¡®çš„ **locale** æ¥è§£æ Unicode å­—ç¬¦
- Fontconfig éœ€è¦æ­£ç¡®é…ç½®æ‰èƒ½æ‰¾åˆ°å¹¶åŠ è½½å­—ä½“
- æ²¡æœ‰ UTF-8 localeï¼Œä¸­æ–‡ï¼ˆUTF-8 ç¼–ç ï¼‰ä¼šè¢«å½“ä½œäºŒè¿›åˆ¶æ•°æ®å¤„ç†

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå®Œæ•´é…ç½®ï¼ˆæ¨èï¼‰

åœ¨ `Dockerfile` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```dockerfile
# ä½¿ç”¨ Node.js å®˜æ–¹é•œåƒï¼ˆåŸºäº Debianï¼‰
FROM node:20-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£… canvas ç›¸å…³çš„ç³»ç»Ÿä¾èµ–ã€ä¸­æ–‡æ”¯æŒå’Œ curlï¼ˆç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN apt-get update && apt-get install -y \
    build-essential \
    libcairo2-dev \
    libpango1.0-dev \
    libjpeg-dev \
    libgif-dev \
    librsvg2-dev \
    libpixman-1-dev \
    pkg-config \
    python3 \
    curl \
    locales \          # â† è¯­è¨€ç¯å¢ƒåŒ…
    fontconfig \       # â† å­—ä½“é…ç½®ç®¡ç†å·¥å…·
    fonts-wqy-zenhei \ # â† æ–‡æ³‰é©¿æ­£é»‘å­—ä½“ï¼ˆfallbackï¼‰
    && rm -rf /var/lib/apt/lists/*

# é…ç½® UTF-8 localeï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
RUN sed -i 's/^# *zh_CN.UTF-8/zh_CN.UTF-8/' /etc/locale.gen && \
    locale-gen zh_CN.UTF-8 && \
    update-locale LANG=zh_CN.UTF-8

# è®¾ç½® locale ç¯å¢ƒå˜é‡
ENV LANG=zh_CN.UTF-8 \
    LC_ALL=zh_CN.UTF-8 \
    LANGUAGE=zh_CN:zh

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç ã€å·¥å…·ç±»å’Œå­—ä½“
COPY src/ ./src/
COPY utils/ ./utils/
COPY font/ ./font/

# åˆ·æ–°å­—ä½“ç¼“å­˜ï¼ˆç¡®ä¿è‡ªå®šä¹‰å­—ä½“è¢«è¯†åˆ«ï¼‰
RUN fc-cache -fv

# æš´éœ²ç«¯å£
EXPOSE 3301

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3301

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

### æ–¹æ¡ˆäºŒï¼šæœ€å°åŒ–é…ç½®ï¼ˆä¸æ¨èï¼‰

å¦‚æœé•œåƒå¤§å°æ•æ„Ÿï¼Œå¯ä»¥åªè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä½†ä¸ä¿è¯æ‰€æœ‰æƒ…å†µéƒ½æœ‰æ•ˆï¼‰ï¼š

```dockerfile
ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8
```

## ğŸ› é¢å¤–é—®é¢˜ï¼šå­—ä½“æ–‡ä»¶åŠ è½½å¤±è´¥

### é—®é¢˜ç°è±¡

å®¹å™¨å¯åŠ¨åçœ‹åˆ°æ—¥å¿—ï¼š
```
å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨: /app/font/å®‹ä½“.TTCï¼Œå°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“
```

ä½†æ˜¯å­—ä½“æ–‡ä»¶æ˜æ˜å­˜åœ¨ï¼

### æ ¹æœ¬åŸå› 

**æ–‡ä»¶åå¤§å°å†™ä¸åŒ¹é…**ï¼š

- å®é™…æ–‡ä»¶åï¼š`å®‹ä½“.ttc`ï¼ˆå°å†™æ‰©å±•åï¼‰
- ä»£ç ä¸­å¼•ç”¨ï¼š`å®‹ä½“.TTC`ï¼ˆå¤§å†™æ‰©å±•åï¼‰

### ä¸ºä»€ä¹ˆæœ¬åœ°æ­£å¸¸ï¼Ÿ

| æ“ä½œç³»ç»Ÿ | æ–‡ä»¶ç³»ç»Ÿ | å¤§å°å†™æ•æ„Ÿæ€§ | ç»“æœ |
|---------|---------|-------------|------|
| macOS | HFS+/APFSï¼ˆé»˜è®¤ï¼‰ | âŒ ä¸æ•æ„Ÿ | `.TTC` = `.ttc` âœ… |
| Linux (Docker) | ext4/overlay2 | âœ… æ•æ„Ÿ | `.TTC` â‰  `.ttc` âŒ |

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹ä»£ç ä¸­çš„æ–‡ä»¶æ‰©å±•åä¸ºå°å†™ï¼š**

```javascript
// ä¿®æ”¹å‰
const fontPath = path.join(__dirname, '../font/å®‹ä½“.TTC');

// ä¿®æ”¹å
const fontPath = path.join(__dirname, '../font/å®‹ä½“.ttc');
```

**æœ€ä½³å®è·µ**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨å°å†™æ‰©å±•åï¼ˆç¬¦åˆ Linux/Unix æƒ¯ä¾‹ï¼‰
- âœ… åœ¨ä»£ç ä¸­ä½¿ç”¨å®é™…æ–‡ä»¶å
- âŒ é¿å…åœ¨è·¨å¹³å°é¡¹ç›®ä¸­ä½¿ç”¨å¤§å°å†™æ··åˆçš„æ–‡ä»¶å

## ğŸ” è¯Šæ–­å·¥å…·

### è¿›å…¥å®¹å™¨æ£€æŸ¥ç¯å¢ƒ

```bash
# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it generate-seal /bin/bash

# 1. æ£€æŸ¥ locale è®¾ç½®
locale
# åº”è¯¥æ˜¾ç¤ºï¼š
# LANG=zh_CN.UTF-8
# LC_ALL=zh_CN.UTF-8

# 2. æ£€æŸ¥å¯ç”¨çš„ locale
locale -a
# åº”è¯¥åŒ…å«ï¼šzh_CN.utf8

# 3. æ£€æŸ¥å­—ä½“æ–‡ä»¶
ls -la /app/font/
# ç¡®è®¤æ–‡ä»¶å­˜åœ¨åŠæ‰©å±•åå¤§å°å†™

# 4. æ£€æŸ¥å­—ä½“ç¼“å­˜
fc-list | grep -i "å®‹ä½“"
fc-list | grep -i "WenQuanYi"

# 5. æµ‹è¯•å­—ä½“åŠ è½½
fc-match "å®‹ä½“"

# é€€å‡ºå®¹å™¨
exit
```

### æµ‹è¯•å°ç« ç”Ÿæˆ

```bash
# æµ‹è¯• GET è¯·æ±‚
curl "http://localhost:3301/api/seal?name=æµ‹è¯•å…¬å¸å°ç« " --output test.png

# æµ‹è¯• POST è¯·æ±‚ï¼ˆè¿”å› Base64ï¼‰
curl -X POST http://localhost:3301/api/seal \
  -H "Content-Type: application/json" \
  -d '{"name":"æ·±åœ³å¸‚è…¾è®¯ç§‘æŠ€æœ‰é™å…¬å¸"}' \
  | jq -r '.data.image' | sed 's/data:image\/png;base64,//' | base64 -d > test2.png

# æŸ¥çœ‹ç”Ÿæˆçš„å›¾ç‰‡
open test.png  # macOS
```

## ğŸ“¦ å®Œæ•´éƒ¨ç½²æµç¨‹

### 1. åœæ­¢æ—§å®¹å™¨

```bash
docker compose down
```

### 2. é‡æ–°æ„å»ºé•œåƒ

```bash
# å®Œå…¨é‡æ–°æ„å»ºï¼ˆæ¨èåœ¨ä¿®æ”¹ Dockerfile åä½¿ç”¨ï¼‰
docker compose build --no-cache

# å¿«é€Ÿæ„å»ºï¼ˆä»…ä»£ç ä¿®æ”¹æ—¶ï¼‰
docker compose build
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# åå°è¿è¡Œ
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f
```

### 4. éªŒè¯æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3301/health

# ç”Ÿæˆæµ‹è¯•å°ç« 
curl "http://localhost:3301/api/seal?name=æµ‹è¯•å°ç« " --output test.png
```

## ğŸ“Š é…ç½®å¯¹æ¯”

### ä¿®æ”¹å‰ vs ä¿®æ”¹å

```diff
  FROM node:20-slim
  
  WORKDIR /app
  
  RUN apt-get update && apt-get install -y \
      build-essential \
      libcairo2-dev \
      libpango1.0-dev \
      libjpeg-dev \
      libgif-dev \
      librsvg2-dev \
      libpixman-1-dev \
      pkg-config \
      python3 \
      curl \
+     locales \
+     fontconfig \
+     fonts-wqy-zenhei \
      && rm -rf /var/lib/apt/lists/*
  
+ # é…ç½® UTF-8 locale
+ RUN sed -i 's/^# *zh_CN.UTF-8/zh_CN.UTF-8/' /etc/locale.gen && \
+     locale-gen zh_CN.UTF-8 && \
+     update-locale LANG=zh_CN.UTF-8
+ 
+ # è®¾ç½® locale ç¯å¢ƒå˜é‡
+ ENV LANG=zh_CN.UTF-8 \
+     LC_ALL=zh_CN.UTF-8 \
+     LANGUAGE=zh_CN:zh
  
  COPY package*.json ./
  RUN npm ci --only=production
  
  COPY src/ ./src/
  COPY utils/ ./utils/
  COPY font/ ./font/
  
+ # åˆ·æ–°å­—ä½“ç¼“å­˜
+ RUN fc-cache -fv
  
  EXPOSE 3301
  
  ENV NODE_ENV=production
  ENV PORT=3301
  
  CMD ["npm", "start"]
```

## ğŸ¯ æ€»ç»“

### å…³é”®ä¿®æ”¹ç‚¹

1. âœ… **å®‰è£… locales åŒ…** - æä¾›è¯­è¨€ç¯å¢ƒæ”¯æŒ
2. âœ… **ç”Ÿæˆ zh_CN.UTF-8 locale** - å¯ç”¨ä¸­æ–‡ UTF-8 æ”¯æŒ
3. âœ… **è®¾ç½®ç¯å¢ƒå˜é‡** - è®©åº”ç”¨ä½¿ç”¨æ­£ç¡®çš„ locale
4. âœ… **å®‰è£… fontconfig** - å­—ä½“ç®¡ç†å·¥å…·
5. âœ… **å®‰è£… fallback å­—ä½“** - ç³»ç»Ÿçº§ä¸­æ–‡å­—ä½“å¤‡ä»½
6. âœ… **åˆ·æ–°å­—ä½“ç¼“å­˜** - ç¡®ä¿è‡ªå®šä¹‰å­—ä½“è¢«è¯†åˆ«
7. âœ… **ä¿®æ­£æ–‡ä»¶åå¤§å°å†™** - è§£å†³è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜

### é¢„é˜²æªæ–½

- ğŸ“ å¼€å‘æ—¶æ³¨æ„æ–‡ä»¶åå¤§å°å†™
- ğŸ§ª åœ¨ Docker ç¯å¢ƒä¸­æµ‹è¯•åå†éƒ¨ç½²
- ğŸ“š ä¿æŒæ–‡æ¡£æ›´æ–°
- ğŸ” ä½¿ç”¨è¯Šæ–­å·¥å…·å®šæœŸæ£€æŸ¥

## ğŸ”— ç›¸å…³èµ„æº

- [Pango å®˜æ–¹æ–‡æ¡£](https://docs.gtk.org/Pango/)
- [Fontconfig é…ç½®æŒ‡å—](https://www.freedesktop.org/wiki/Software/fontconfig/)
- [node-canvas GitHub](https://github.com/Automattic/node-canvas)
- [Debian Locale é…ç½®](https://wiki.debian.org/Locale)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-11  
**ç»´æŠ¤è€…**: é¡¹ç›®ç»„
